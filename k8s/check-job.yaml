apiVersion: batch/v1
kind: Job
metadata:
  name: checksum-check-job
  labels:
    app: consistency-check
spec:
  template:
    metadata:
      labels:
        app: consistency-check
    spec:
      restartPolicy: Never
      containers:
      - name: checker
        image: postgres:15-alpine
        command: ["/bin/sh"]
        args:
        - -c
        - |
          apk add --no-cache bash
          /scripts/check-data-checksums.sh
        env:
        - name: DB_HOST
          value: "postgres-service"
        - name: DB_PORT
          value: "5432"
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: postgres-config
              key: POSTGRES_DB
        - name: DB_USER
          valueFrom:
            configMapKeyRef:
              name: postgres-config
              key: POSTGRES_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_PASSWORD
        volumeMounts:
        - name: check-scripts
          mountPath: /scripts
      volumes:
      - name: check-scripts
        configMap:
          name: check-scripts
          defaultMode: 0755
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: check-scripts
data:
  check-data-checksums.sh: |
    #!/bin/bash
    
    # EDB/PostgreSQL Data Checksums Consistency Check
    # This script checks if data checksums are enabled in the database
    
    set -e
    
    # Colors for output
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m' # No Color
    
    # Database connection parameters
    DB_HOST="${DB_HOST:-postgres-service}"
    DB_PORT="${DB_PORT:-5432}"
    DB_NAME="${DB_NAME:-testdb}"
    DB_USER="${DB_USER:-postgres}"
    DB_PASSWORD="${DB_PASSWORD:-postgres123}"
    
    echo "======================================"
    echo "EDB Consistency Check - Data Checksums"
    echo "======================================"
    echo ""
    
    # Wait for database to be ready
    echo "Waiting for PostgreSQL to be ready..."
    max_attempts=30
    attempt=0
    
    while [ $attempt -lt $max_attempts ]; do
        if PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c '\q' 2>/dev/null; then
            echo -e "${GREEN}✓ Database is ready${NC}"
            break
        fi
        attempt=$((attempt + 1))
        echo "Attempt $attempt/$max_attempts - Database not ready yet..."
        sleep 2
    done
    
    if [ $attempt -eq $max_attempts ]; then
        echo -e "${RED}✗ Failed to connect to database after $max_attempts attempts${NC}"
        exit 1
    fi
    
    echo ""
    echo "Running consistency check: SHOW data_checksums"
    echo "--------------------------------------"
    
    # Run the checksum query
    CHECKSUM_RESULT=$(PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -t -c "SHOW data_checksums;" | xargs)
    
    echo "Result: $CHECKSUM_RESULT"
    echo ""
    
    # Evaluate the result
    if [ "$CHECKSUM_RESULT" = "on" ]; then
        echo -e "${GREEN}✓ PASS: Data checksums are ENABLED${NC}"
        echo "  This means PostgreSQL will detect data corruption by verifying checksums"
        echo "  on data pages when they are read from disk."
        exit 0
    elif [ "$CHECKSUM_RESULT" = "off" ]; then
        echo -e "${YELLOW}⚠ WARNING: Data checksums are DISABLED${NC}"
        echo "  Data checksums provide protection against storage corruption."
        echo "  Consider enabling them for production databases."
        echo ""
        echo "  Note: Checksums can only be enabled during database initialization"
        echo "  using 'initdb --data-checksums' or postgres '-c data_checksums=on'"
        exit 1
    else
        echo -e "${RED}✗ ERROR: Unexpected result: $CHECKSUM_RESULT${NC}"
        exit 1
    fi
